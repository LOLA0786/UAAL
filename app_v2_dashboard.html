<!DOCTYPE html>
<html>
<head><meta charset="utf-8"/><title>UAAL Admin Console</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{--bg:#f5f6f8;--card:#fff;--accent:#1976D2}
[data-theme="dark"]{--bg:#0e1114;--card:#0b0d10;--accent:#4ea3ff;color:#ddd}
body{font-family:Inter,Arial;margin:0;background:var(--bg);color:inherit}
header{display:flex;justify-content:space-between;padding:12px 20px;background:var(--card)}
.container{padding:20px;max-width:1200px;margin:0 auto}
.card{background:var(--card);padding:12px;border-radius:8px;margin-bottom:12px;box-shadow:0 1px 6px rgba(0,0,0,0.04)}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:6px;border-bottom:1px solid #eee}
.btn{padding:6px 10px;border-radius:6px;background:var(--accent);color:#fff;border:none}
.small{font-size:13px;color:#666}
</style>
</head>
<body data-theme="light">
<header><div><strong>UAAL Admin Console</strong> <span class="small">local dev</span></div><div><button id="toggle">Dark</button></div></header>
<div class="container">
  <div class="card"><h3>Latest Actions</h3><div id="actions">loading...</div></div>
  <div class="card"><h3>Actions per Agent</h3><canvas id="actionsChart"></canvas></div>
  <div class="card"><h3>Spend per Agent</h3><canvas id="spendChart"></canvas></div>
  <div class="card"><h3>Approval Queue</h3><div id="queue">loading...</div></div>
  <div class="card"><h3>Anomalies</h3><div id="anoms">loading...</div></div>
</div>
<script>
const state={token:null, apiKey:null};
function authHeaders(){const h={'Content-Type':'application/json'}; if(state.token) h['Authorization']='Bearer '+state.token; if(state.apiKey) h['x-api-key']=state.apiKey; return h}
async function load(){
  const acts = await fetch('/api/v1/actions',{headers:authHeaders()}).then(r=>r.json());
  let html='<table class="table"><tr><th>ID</th><th>Agent</th><th>Verb</th><th>Confidence</th><th>State</th><th>Time</th></tr>';
  for(const a of acts.slice(0,50)){ html+=`<tr><td style="word-break:break-all">${a.action_id}</td><td>${a.actor_id}</td><td>${a.verb}</td><td>${a.confidence}</td><td>${a.state}</td><td>${a.timestamp}</td></tr>`}
  html+='</table>'; document.getElementById('actions').innerHTML=html;

  const perAgent = await fetch('/api/v1/metrics/actions_per_agent').then(r=>r.json());
  new Chart(document.getElementById('actionsChart'),{type:'bar',data:{labels:perAgent.map(x=>x.actor_id),datasets:[{label:'Actions',data:perAgent.map(x=>x.count)}]}});
  const spend = await fetch('/api/v1/metrics/spend_by_agent').then(r=>r.json());
  new Chart(document.getElementById('spendChart'),{type:'bar',data:{labels:spend.map(x=>x.actor_id),datasets:[{label:'Spent',data:spend.map(x=>x.spent)}]}});

  const q = await fetch('/api/v1/metrics/approval_queue').then(r=>r.json());
  document.getElementById('queue').innerHTML = q.length? '<ul>'+q.map(i=>'<li>'+i.action_id+' - '+i.verb+' by '+i.actor_id+'</li>').join('')+'</ul>' : '<p>No pending items</p>';

  const an = await fetch('/api/v1/anomalies/low_confidence').then(r=>r.json());
  document.getElementById('anoms').innerHTML = an.length? '<ul>'+an.map(x=>'<li>'+x.action_id+' conf='+x.confidence+'</li>').join('')+'</ul>' : '<p>No anomalies detected</p>';
}
document.getElementById('toggle').onclick = ()=>{const root=document.body; if(root.getAttribute('data-theme')==='light'){root.setAttribute('data-theme','dark'); document.getElementById('toggle').innerText='Light'} else {root.setAttribute('data-theme','light'); document.getElementById('toggle').innerText='Dark'}};
load();
const es=new EventSource('/api/v1/stream'); es.onmessage = (e)=>{ try { const obj=JSON.parse(e.data); if(obj.type && obj.type.startsWith('action.')) load(); } catch(e){} };
</script>
</body>
</html>
